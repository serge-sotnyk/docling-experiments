# Feature Plan 0002: Processing Details Logging

## Description

Add processing details logging functionality to the existing PDF to Markdown utility (developed in 0001_PLAN.md). The utility will save detailed processing information in a formatted JSON file alongside the original PDF with the naming format `{original_pdf_name}.json`. This enhancement addresses the issue of long processing times by providing transparency into processing duration, document metadata, and utility parameters.

## Files and Functions to be Changed/Created

### Files to Modify:
- `src/pdf_to_markdown/converter.py` - Add timing, metadata extraction, and JSON logging functionality
- `src/pdf_to_markdown/cli.py` - Add command-line parameters capture and enable/disable logging options
- `pyproject.toml` - Add JSON handling dependency (if needed)

### New Files to Create:
- `src/pdf_to_markdown/logger.py` - Processing details logging class with JSON output
- `src/pdf_to_markdown/metadata.py` - Document metadata extraction utilities

### Dependencies to Add (via uv):
- Standard library modules only: `json`, `time`, `datetime` (already available)

## Technical Implementation Details

### Algorithm Steps:

1. **Processing Timer Integration**:
   - Wrap the main conversion process with high-precision timing using `time.perf_counter()`
   - Start timer before `doc_converter.convert()` call
   - Stop timer after successful conversion and markdown export
   - Calculate total processing duration in seconds

2. **Metadata Extraction from Docling Result**:
   - Extract page count from `result.document` structure
   - Access document metadata through Docling's document model
   - Explore `result.document.pages` or similar structures for page information
   - Extract conversion status and any quality indicators
   - Gather OCR language settings and pipeline configuration used

3. **Command-Line Parameters Capture**:
   - Capture all CLI arguments passed to the utility
   - Store original command-line invocation
   - Record OCR language settings, verbose flags, and output paths
   - Include utility version information

4. **Processing Speed Calculation**:
   - If page count is available: `pages_per_second = page_count / processing_time_seconds`
   - If page count is unavailable: note this in the JSON output
   - Include both absolute processing time and relative speed metrics

5. **JSON Output Generation**:
   - Create structured JSON with processing details
   - Save with filename: `{original_pdf_name}.json` in same directory as PDF
   - Include timestamp of when processing was executed
   - Handle JSON serialization errors gracefully

### Core Implementation Structure:

```python
# logger.py structure
class ProcessingLogger:
    def __init__(self):
        # Initialize logging configuration
        
    def start_timing(self) -> None:
        # Start processing timer
        
    def stop_timing(self) -> float:
        # Stop timer and return duration
        
    def extract_metadata(self, result: ConversionResult, pdf_path: Path) -> dict:
        # Extract document metadata from Docling result
        
    def create_log_entry(self, **kwargs) -> dict:
        # Create complete log entry structure
        
    def save_processing_log(self, log_data: dict, output_path: Path) -> None:
        # Save JSON log to file

# metadata.py structure  
class DocumentMetadata:
    @staticmethod
    def get_page_count(document) -> int | None:
        # Extract page count from Docling document
        
    @staticmethod
    def get_document_info(document) -> dict:
        # Extract additional document information
        
    @staticmethod
    def calculate_processing_speed(page_count: int | None, duration: float) -> dict:
        # Calculate processing speed metrics
```

### JSON Output Structure:

```json
{
  "processing_details": {
    "processing_time_seconds": 45.23,
    "start_time": "2024-01-15T14:30:22.123Z",
    "end_time": "2024-01-15T14:31:07.353Z"
  },
  "document_metadata": {
    "page_count": 12,
    "conversion_status": "SUCCESS",
    "file_size_bytes": 2048576,
    "has_ocr_content": true,
    "estimated_text_pages": 10
  },
  "processing_speed": {
    "seconds_per_page": 3.77,
    "pages_per_minute": 15.92
  },
  "utility_parameters": {
    "input_file": "/path/to/document.pdf",
    "output_file": "/path/to/document.pdf.md",
    "ocr_languages": ["en"],
    "verbose_mode": true,
    "command_line": "pdf-to-md document.pdf --verbose --languages en"
  },
  "system_info": {
    "utility_version": "0.1.0",
    "docling_version": "2.44.0",
    "python_version": "3.13.0"
  }
}
```

### Integration with Existing Code:

1. **Converter Class Modifications**:
   - Add optional `enable_logging: bool` parameter to `__init__`
   - Modify `convert_pdf_to_markdown()` to include timing and metadata extraction
   - Add new method `convert_with_logging()` that wraps existing conversion
   - Extract page count from `result.document` using document structure inspection

2. **CLI Interface Updates**:
   - Add `--disable-logging` flag to optionally skip JSON generation
   - Add `--log-output` option for custom log file path
   - Capture all command-line arguments for logging
   - Pass logging configuration to converter instance

3. **Error Handling Extensions**:
   - Handle JSON serialization errors
   - Gracefully handle missing metadata (e.g., page count unavailable)
   - Include error information in log if conversion partially fails
   - Ensure log file is written even if conversion fails (with error details)

### Docling Metadata Research Results:

Based on Docling documentation analysis:
- Page information available through document structure
- Conversion status accessible via `result.status`
- Document elements contain page references (`page_no`)
- Potential access to document properties through `result.document` inspection
- OCR content detection possible through document analysis

### Backward Compatibility:

- Logging enabled by default (to provide immediate value)
- Existing CLI interface remains unchanged
- New functionality is additive only
- No breaking changes to existing conversion workflow
- JSON logging can be disabled via command-line flag

### Development Workflow:

1. Implement `ProcessingLogger` and `DocumentMetadata` classes
2. Modify `PDFToMarkdownConverter` to integrate logging
3. Update CLI to support new logging options
4. Test with various PDF documents to validate metadata extraction
5. Ensure JSON output handles edge cases (no pages, OCR failures, etc.)

### Error Scenarios to Handle:

- Page count extraction failures → log as `null` with explanation
- JSON serialization errors → create minimal log with error details
- File write permission errors → display warning but don't fail conversion
- Metadata unavailable → include partial information with missing data indicators
- Processing timer failures → estimate based on file size or skip timing data
